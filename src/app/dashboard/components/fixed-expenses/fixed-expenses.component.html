<div class="fixed-expenses">
  <mat-card class="expenses-card" [class.collapsed]="isCollapsed">
    <mat-card-header class="collapsible-header" 
                     (click)="onToggleCollapse()" 
                     (touchstart)="onToggleCollapse()">
      <div class="header-content">
        <mat-card-title>
          <mat-icon>account_balance_wallet</mat-icon>
          Gastos Fijos
        </mat-card-title>
        <mat-card-subtitle>
          {{ getTotalPaidCount() }} de {{ expenses.length }} pagados 
          ({{ getPaidPercentage() | number:'1.0-0' }}%)
        </mat-card-subtitle>
      </div>
      <button mat-icon-button class="collapse-button" 
              (click)="onToggleCollapse(); $event.stopPropagation()"
              (touchstart)="onToggleCollapse(); $event.stopPropagation()">
        <mat-icon>{{ isCollapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
      </button>
    </mat-card-header>

    <!-- Filtros -->
    <div *ngIf="!isCollapsed" class="filters-container" (click)="$event.stopPropagation()">
      <mat-chip-set aria-label="Filtros de gastos" class="filter-chip-set">
        <mat-chip-option 
          *ngFor="let option of filterOptions"
          [selected]="isFilterActive(option.value)"
          (click)="setFilter(option.value)"
          class="filter-chip">
          <span class="filter-label">{{ option.label }}</span>
          <span class="filter-count">{{ getFilterCount(option.value) }}</span>
        </mat-chip-option>
      </mat-chip-set>
    </div>

    <mat-card-content [class.collapsed]="isCollapsed">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <span>Cargando gastos fijos...</span>
      </div>

      <!-- Error State -->
      <div *ngIf="error && !isLoading" class="error-container">
        <mat-icon color="warn">error</mat-icon>
        <span>{{ error }}</span>
        <button mat-button color="primary" (click)="refreshExpenses()">
          <mat-icon>refresh</mat-icon>
          Reintentar
        </button>
      </div>

      <!-- Expenses Content -->
      <div *ngIf="!isLoading && !error" class="pockets-container">
        
        <!-- No expenses message -->
        <div *ngIf="expenses.length === 0" class="no-expenses">
          <mat-icon>receipt_long</mat-icon>
          <span>No hay gastos fijos registrados este mes</span>
        </div>

        <!-- No filtered expenses message -->
        <div *ngIf="expenses.length > 0 && filteredExpenses.length === 0" class="no-expenses">
          <mat-icon>filter_list_off</mat-icon>
          <span>No hay gastos que coincidan con el filtro seleccionado</span>
        </div>

        <!-- Expenses by pocket -->
        <div *ngFor="let pocketName of getPocketKeys()" class="pocket-group">
          
          <!-- Pocket Header -->
          <div class="pocket-header">
            <h3 class="pocket-title">{{ pocketName }}</h3>
            <div class="pocket-summary">
              <span class="pocket-total">
                {{ getPocketTotal(pocketName) | currency:'COP':'symbol':'1.0-0' }}
              </span>
              <span class="pocket-status">
                {{ getPocketPaidCount(pocketName) }} de {{ expensesByPocket[pocketName].length }} pagados
              </span>
            </div>
          </div>

          <!-- Expenses List -->
          <div class="expenses-list">
            <div *ngFor="let expense of expensesByPocket[pocketName]" 
                 class="expense-item"
                 [class]="isHybridExpense(expense) ? 'hybrid-expense ' + getHybridStatus(expense) : getExpenseStatus(expense)">
              
              <!-- GASTO FIJO TRADICIONAL -->
              <ng-container *ngIf="!isHybridExpense(expense)">
                <!-- Checkbox -->
                <mat-checkbox 
                  [checked]="expense.is_paid"
                  (change)="togglePaymentStatus(expense)"
                  [color]="'primary'">
                </mat-checkbox>

                <!-- Expense Details -->
                <div class="expense-details">
                  <span class="expense-name">{{ expense.concept_name }}</span>
                  <span class="expense-amount">
                    {{ expense.amount | currency:'COP':'symbol':'1.0-0' }}
                  </span>
                  <span class="expense-date">
                    Día {{ expense.payment_day }}
                    <span *ngIf="expense.paid_date" class="paid-date">
                      - Pagado {{ expense.paid_date }}
                    </span>
                  </span>
                </div>

                <!-- Status Text -->
                <span class="status-text" [class]="getExpenseStatus(expense)">
                  {{ expense.is_paid ? 'Pagado' : (getExpenseStatus(expense) === 'overdue' ? 'Vencido' : 'Pendiente') }}
                </span>
              </ng-container>

              <!-- GASTO HÍBRIDO -->
              <ng-container *ngIf="isHybridExpense(expense)">
                <!-- Progress Indicator -->
                <div class="progress-indicator">
                  <mat-progress-bar 
                    [value]="getProgressPercentage(expense)"
                    [color]="getProgressColor(expense)"
                    mode="determinate">
                  </mat-progress-bar>
                </div>

                <!-- Expense Details -->
                <div class="expense-details hybrid-details">
                  <div class="expense-header">
                    <span class="expense-name">
                      <mat-icon class="hybrid-icon">trending_up</mat-icon>
                      {{ expense.concept_name }}
                    </span>
                    <span class="expense-budget">
                      {{ getCurrentSpent(expense) | currency:'COP':'symbol':'1.0-0' }} / 
                      {{ (expense.budget_limit || 0) | currency:'COP':'symbol':'1.0-0' }}
                    </span>
                  </div>
                  
                  <div class="expense-meta">
                    <span class="progress-text">
                      {{ getBudgetStatusText(expense) }}
                    </span>
                    <span class="remaining-budget" *ngIf="getRemainingBudget(expense) > 0">
                      Disponible: {{ getRemainingBudget(expense) | currency:'COP':'symbol':'1.0-0' }}
                    </span>
                  </div>
                </div>

                <!-- Quick Actions -->
                <div class="expense-actions">
                  <button mat-icon-button 
                          (click)="openQuickTransactionModal(expense)"
                          class="quick-add-btn"
                          matTooltip="Agregar transacción"
                          [disabled]="getProgressPercentage(expense) >= 100">
                    <mat-icon>add_circle</mat-icon>
                  </button>
                  
                  <button mat-icon-button 
                          (click)="openHybridTransactionsModal(expense)"
                          class="details-btn"
                          matTooltip="Ver detalles">
                    <mat-icon>visibility</mat-icon>
                  </button>
                </div>
              </ng-container>
            </div>
          </div>

          <mat-divider *ngIf="getPocketKeys().indexOf(pocketName) < getPocketKeys().length - 1"></mat-divider>
        </div>

        <!-- Summary Footer -->
        <div *ngIf="filteredExpenses.length > 0" class="expenses-summary">
          <mat-divider></mat-divider>
          <div class="summary-row">
            <span class="summary-label">
              {{ currentFilter === 'all' ? 'Total Gastos Fijos:' : 
                 currentFilter === 'paid' ? 'Total Pagados:' : 'Total Pendientes:' }}
            </span>
            <span class="summary-total">
              {{ getFilteredTotal() | currency:'COP':'symbol':'1.0-0' }}
            </span>
          </div>
        </div>

      </div>
    </mat-card-content>
  </mat-card>
</div>